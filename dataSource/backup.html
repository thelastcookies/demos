@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title></title>
    <script src="@Url.Content("~/Content/Js/jquery-1.9.1.js")"></script>
    <link href="@Url.Content("~/Content/Style/Page/CustomTrend.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/Trend/css/zTreeStyle/zTreeStyle.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/My97DatePicker_Gray/skin/WdatePicker.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Content/Js/math.js")"></script>
    <script src="@Url.Content("~/Content/HighChart/highcharts.js")"></script>
    <script src="@Url.Content("~/Content/My97DatePicker_Gray/WdatePicker.js")"></script>
    <script src="@Url.Content("~/Content/Trend/js/jquery.ztree.core-3.5.js")"></script>
    <script src="@Url.Content("~/Content/Trend/js/jquery.ztree.excheck-3.5.js")"></script>
    <script src="@Url.Content("~/Content/Trend/js/PrintExcel.js")"></script>

    <style scoped="scoped">
        .reports {
            width: 265px;
            height: 247px;
            padding: 108px 0 0 20px;
            background: url('../../content/web/calendar/reports.png') transparent no-repeat 0 0;
            margin: 30px 105px 20px;
        }


        * {
            /*box-sizing: border-box;*/
        }

        body {
            /*color: white;*/
            /*background: rgb(9, 13, 33);*/
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* 页面总模块 */
        div#dv_formula {
            width: 800px;
            height: 465px;
            box-sizing: content-box;
            margin: 0 auto;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            margin-left: -400px;
            margin-top: -232.5px;
            background-color: #ffffff;
            z-index: 10000;
            border: 0px solid #ccc;
            filter: progid:DXImageTransform.Microsoft.Shadow(color=#909090,direction=120,strength=3); /*ie*/
            -moz-box-shadow: 0px 2px 10px #909090; /*firefox*/
            -webkit-box-shadow: 0px 2px 10px #909090; /*safari或chrome*/
            box-shadow: 0px 2px 10px #909090; /*opera或ie9*/
        }

        /* 页面的两大模块 开始*/
        div.formula_dialog {
            width: 800px;
            height: 465px;
            /*background-color: rgb(13, 20, 46);*/
            /*background-color: #eee;*/
            border: 1px solid #e5e5e5;
            box-sizing: border-box;
            padding-left: 8px;
            padding-top: 15px;
        }

        div#dv_formula_show {
            display: none;
        }

        div#dv_formula_modify {
            display: none;
        }
        /* 页面的两大模块 结束*/

        /* 每个模块的 top，body，bottom div 开始*/
        div.dialog_top {
            width: 800px;
            height: 25px;
            font-size: 18px;
            padding-left: 25px;
            margin-bottom: 25px;
            /*height: 100px;*/
        }

        div.dialog_name {
            display: inline-block;
            vertical-align: top;
        }

        div.dialog_body {
            width: 100%;
            height: 80%;
            font-size: 0;
        }
        /* 每个模块的 top，body，bottom div 结束*/
        /* dialog_bottom 样式 底部按钮等 开始 */
        div.dialog_bottom {
            padding-left: 600px;
        }

        button.dis_operate_btn {
            width: 53px;
            height: 27px;
            border: solid 1px #e5e5e5;
            background-color: #fff;
            box-sizing: border-box;
            font-size: 12px;
            padding: 0;
            text-align: center;
            line-height: 25px;
            border-radius: 5px;
            margin-left: 18px;
        }
        /* dialog_bottom 样式 底部按钮等 结束 */
        /* 每个模块的 top，body，bottom div 结束*/
        /* 以下为 dv_formula_show 界面的相关样式 */
        div#dv_formula_show {
            padding-right: 15px;
        }

        div#formula_list_div {
            width: 100%;
            height: 80%;
        }

        div#formula_list_container {
            margin-left: 7px;
            border: solid 1px #e5e5e5;
        }

        table.formula_list {
            width: 100%;
            padding: 0;
            font-size: 12px;
            text-align: center;
            line-height: 30px;
            border-collapse: collapse;
        }

        table#formula_list_title {
            border: 0;
            background-color: #e5e5e5;
        }

        div#formula_list_content_container {
            height: 310px;
            box-sizing: border-box;
            overflow: auto;
            margin-top: 1px;
        }

        table#formula_list_content {
            border: 0;
        }

        table#formula_list_content tr:nth-child(2n) {
            border: 0;
            background-color: #e5e5e5;
        }
        table#formula_list_content tr:last-child {
            border-bottom: 1px solid #e5e5e5;
        }
        td.formula_list_content_id {
            display: none;
        }

        th.formula_list_title_name,
        td.formula_list_content_name {
            width: 30%;
        }

        th.formula_list_title_formula,
        td.formula_list_content_formula {
            width: 50%;
        }

        th.formula_list_title_operate,
        td.formula_list_content_operate {
            width: 10%;
        }
        th.formula_list_title_check,
        td.formula_list_content_check {
            width: 10%;
        }
        input.formula_list_content_check_val {
            vertical-align: middle;
        }
        span.formula_list_content_modify,
        span.formula_list_content_del {
            cursor: pointer;
        }
        /* 以上为 dv_formula_show 界面的相关样式 */
        /* 以下为 dv_formula_modify 界面的相关样式 */
        /* dv_formula_modify 页面中 dialog_body 样式 开始*/
        div.dialog_body_line {
            margin-bottom: 10px;
        }

        div.dialog_body_part {
            /*background-color: #bbb;*/
            display: inline-block;
            vertical-align: top;
            margin-right: 10px;
        }

            div.dialog_body_part:last-of-type {
                margin-right: 0;
            }
        /* dv_formula_modify 页面中 dialog_body 样式 结束*/
        /* 数学公式列表 开始 */
        div#dis_title {
            width: 180px;
            height: 26px;
            font-size: 12px;
            border: 1px solid #e5e5e5;
            padding:;
            border-radius: 5px;
            margin-bottom: 10px;
            box-sizing: border-box;
            line-height: 26px;
            text-align: center;
            /*display: inline-block;*/
        }

        div#dis_formula {
            width: 180px;
            height: 130px;
            border: 1px solid #e5e5e5;
            margin:;
            padding: 5px;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 12px;
            overflow: auto;
            /*display: inline-block;*/
        }

        table#math_formula {
            width: 100%;
        }

            table#math_formula tr {
                cursor: pointer;
            }

                table#math_formula tr:hover {
                    background-color: #e5e5e5;
                }
        /* 数学公式列表 结束 */
        /* 输入板样式 开始 */
        div#dis_formula_intro {
            width: 230px;
            height: 165px;
            border: 1px solid #e5e5e5;
            padding: 5px 10px;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 12px;
        }

        div#dis_input {
            width: 350px;
            /*height: 380px;*/
            font-size: 0;
        }

        div.dis_input_line {
        }

            div.dis_input_line:last-of-type button.dis_input_btn {
                margin-bottom: 0px;
            }

        button.dis_input_btn {
            width: 80px;
            height: 35px;
            display: inline-block;
            border: 1px solid #e5e5e5;
            font-size: 15px;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 8px;
            box-sizing: border-box;
            line-height: 33px;
            text-align: center;
            background-color: #fff;
        }

            button.dis_input_btn:last-of-type {
                margin-right: 0;
            }

        button.dis_input_btn_sm {
            width: 35px;
        }
        /* 输入板样式 结束 */
        /* 数据源列表样式 开始 */
        div#station_list_container {
            width: 420px;
            height: 165px;
            box-sizing: border-box;
            border: solid 1px #e5e5e5;
        }

        table.station_list {
            width: 100%;
            padding: 0;
            font-size: 12px;
            text-align: center;
            line-height: 30px;
            border-collapse: collapse;
        }

        table.station_list_title {
            border: 0;
            background-color: #e5e5e5;
        }

        div.station_list_content_container {
            height: 126px;
            box-sizing: border-box;
            overflow: auto;
            margin-top: 1px;
        }

        table#station_list_content {
            border: 0;
            cursor: pointer;
        }

            table#station_list_content tr:nth-child(2n) {
                border: 0;
                background-color: #e5e5e5;
            }

        th.station_list_title_data,
        td.station_list_content_data {
            width: 30%;
        }

        th.station_list_title_name,
        td.station_list_content_name {
            width: 50%;
        }

        th.station_list_title_value,
        td.station_list_content_value {
            width: 20%;
        }
        /* 数据源列表样式 结束 */
        /* 公式显示区和结果预览 开始 */
        div#dis_output {
            width: 350px;
            height: 165px;
            border: solid 1px #e5e5e5;
            box-sizing: border-box;
            border-radius: 5px;
            font-size: 12px;
        }

        div#dis_output_formula {
            width: 100%;
            height: 130px;
            box-sizing: border-box;
            padding: 15px 10px;
            line-height: 20px;
            overflow: auto;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        span.dis_output_source {
            background-color: #ddd;
        }

        div#dis_output_result {
            width: 100%;
            height: 30px;
            border-top: solid 1px #e5e5e5;
            box-sizing: border-box;
            padding: 0 10px;
            line-height: 30px;
        }
        /* 公式显示区和结果预览 结束 */
        /* 点击保存之后的确认界面 开始 */
        div.dv_formula_confirm {
            width: 400px;
            height: 247.2px;
            border: solid 1px #e5e5e5;
            box-sizing: border-box;
            background-color: #fff;
            position: fixed;
            top: 50%;
            left: 50%;
            margin-left: -200px;
            margin-top: -123.6px;
            z-index: 10002;
            display: none;
        }

        div.dialog_confirm_top {
            padding: 15px 15px 0 25px;
            font-size: 18px;
            line-height: 18px;
            box-sizing: border-box;
        }

        div.dialog_confirm_body {
            height: 174.2px;
            box-sizing: border-box;
            padding: 15px;
        }

        div.dialog_confirm_body_name {
            height: 72.1px;
            box-sizing: border-box;
            padding: 5px;
        }

        div.dialog_confirm_body_name_title {
            font-size: 12px;
            line-height: 18px;
        }

        div.dialog_confirm_body_name_input {
        }

        input.confirm_formula_title {
            border: 0;
            border-bottom: 1px solid #e5e5e5;
            width: 300px;
            height: 30px;
            margin: 5px 20px;
            font-size: 15px;
            line-height: 15px;
            padding: 1px 15px;
        }

            input.confirm_formula_title:focus {
                box-shadow: 1px;
                outline: none;
            }

        div.dialog_confirm_body_formula {
            height: 72.1px;
            box-sizing: border-box;
            font-size: 12px;
            line-height: 18px;
            border: solid 1px #e5e5e5;
            background-color: #efefef;
            padding: 15px;
            overflow-y: auto;
        }

        div.dialog_confirm_bottom {
            height: 40px;
            padding-left: 225px;
            box-sizing: border-box;
        }
        div#dialogBg_confirm {
            width: 100%;
            height: 100%;
            background-color: #000000;
            opacity: .3;
            filter: alpha(opacity=30);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10001;
            display: none;
        }
        /* 点击保存之后的确认界面 结束 */
        /* 以上为 dv_formula_modify 界面的相关样式 */
        /* 以下为保存模板对话框的相关样式 */
        div#tem_dialog {
            width: 350px;
            height: 190px;
            border: solid 1px #e5e5e5;
            box-sizing: border-box;
            background-color: #fff;
            position: fixed;
            top: 50%;
            left: 50%;
            margin-left: -175px;
            margin-top: -95px;
            display: none;
            z-index: 20001;
        }
        div.tem_dialog_top {
            height: 20px;
            padding: 15px;
        }

        div.tem_dialog_body {
            padding: 15px;
            font-size: 15px;
            height:;
        }
        div#tem_save_title {
            margin-left:10px;
        }

        div.tem_dialog_bottom {
            padding-left: 180px;
        }

        input#tem_save_input {
            width: 270px;
        }
        #tem_btn_close {
            margin-left: 220px;
        }
        #dialog_load {
            width: 300px;
            height: 200px;
            position: fixed;
            top: 50%;
            left: 50%;
            margin-left: -150px;
            margin-top: -100px;
        }
    </style>

    <script type="text/javascript" language="javascript">

        $(function () {
            //window.parent.window.gotoScrollTop();

            var templeteID = "";
            var templeteName = "";

            setLoaction();//自适应

            Data();//时间框赋值
            LoadData();//初始化数据
            LoadBody();//初始化树

            getSrceenWH();//获取页面宽度，高度
            SearchTree();
            

            //$("#btn_save").click(function () {
            //    var box = 300;
            //    var th = $(window).height() / 2.5 - 75;
            //    var rw = $(window).width() / 2 - 150;
            //    $("#dv_Save_body").animate({ top: th, opacity: 'show', width: 300, height: 150, left: rw }, 500);
            //    $('#dialogBg').fadeIn();
            //});

            //updatePoint();
            //console.log("页面加载刷新point", point);

            var setting = {
            view: {
                selectedMulti: false
            },
            check: {
                enable: true
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            callback: {
                beforeCheck: beforeCheck,
                onCheck: onCheck,
                onClick: onClick
            }
        };
        function beforeCheck(treeId, treeNode) {
            return (treeNode.doCheck !== false);
        }
        var point = '', name = '', pid = '', checkVal = 0;;

        function onCheck(e, treeId, treeNode) {
            point = '';
            name = '';
            pid = '';
            var treeObj = $.fn.zTree.getZTreeObj("tree");
            var nodes = treeObj.getCheckedNodes(true);

            for (var i = 0; i < nodes.length; i++) {

                if (treeNode.checked == true) {
                    point += nodes[i].nodeID + ',';
                    name += nodes[i].name + ',';
                    pid += nodes[i].pid + ',';
                }
            }

            if (name == '' || name == undefined) {
                point = '', name = '', pid = '';
                for (var i = 0; i < nodes.length; i++) {
                    point += nodes[i].nodeID + ',';
                    name += nodes[i].name + ',';
                    pid += nodes[i].pid + ',';
                }
                name = name.substring(0, name.length - 1);
                point = point.substring(0, point.length - 1);
                pid = pid.substring(0, pid.length - 1);

                name = name.replace('undefined', '');
                point = point.replace('undefined', '');
                pid = pid.replace('undefined', '');
            
                if (name == '') {
                    //alert('请选择测点');
                    $("#dv_Formula_left_list").html("");
                    $("#dv_table").html('');
                    $("#container").html('');
                }
                else {

                    ShowDiv('dv_Mask', 'dv_fade', point, name);
                    $("#dv_table").hide();
                    $("#container").show();
                }
            } else {
                name = name.substring(0, name.length - 1);
                point = point.substring(0, point.length - 1);
                pid = pid.substring(0, pid.length - 1);
                ShowDiv('dv_Mask', 'dv_fade', point, name);
                $("#dv_table").hide();
                $("#container").show();
            }
        }
        function onClick(event, treeId, treeNode, clickFlag) {

        }

        function LoadBody () {
            $("#sp_title").text('公式名称');
            $("#start").text('开始');
            $("#end").text('结束');
            $("#jiange").text('间隔');
            $("#btn_chart_show").html('查询');
            $("#btn_save").html('保存');
            $("#btn_print").html('打印');
            $("#btn_Formula").html('公式');

            LoadTree();
        }

        function getHeight() {
            var newHeight = $(document.body).height();
            var mainPage = $(window.parent.document).find("#mainPage");
            var main = $(window.parent.document).find("#main");
            mainPage.height(newHeight);
            main.height(newHeight);
        }
        function setLoaction() {
            var wd = $('.right_bottom').width();
            var h = $(window).height();
            //$('#content').css('height', h - 60 + 'px');
            $('#container,#dv_table').css({ 'height': h - 62 + 'px', 'width': wd - 3 + 'px' });

            $('#dv_left').css('height', h - 28 + 'px');
        }


        function AddClick(id) {

            insertIntoOutputFormula(id);

        }


        function SearchTree() {
            $("#btnSearch").click(function () {

                point = '';
                name = '';
                pid = '';
                $("#dv_table").html('');
                $("#container").html('');


                @*$.get('@Url.Content("~/File/Tree.json")', {}, function (data) {
                    var zNodes = eval(data.tree);
                    $.fn.zTree.init($("#tree"), setting, zNodes);
                }, 'json');*@
                $.post('@Url.Content("~/History/GetSearchTree")', { key: $("#txtSearch").val() }, function (data) {
                    var zNodes = eval(data.tree);
                    $.fn.zTree.init($("#tree"), setting, zNodes);
                }, 'json');
            });

        }

        function updatepoint() {
            $.post('@Url.Content("~/History/Updatetree")', {  }, function (data) {
                $.get('@Url.Content("~/File/Tree.json")', {}, function (data) {
                    var zNodes = eval(data.tree);
                    var zTree = $.fn.zTree.init($("#tree"), setting, zNodes);

                }, 'json');
            }, 'json');
        }

            function LoadTree() {
            $.ajax({
                type:"GET",
                url: '@Url.Content("~/File/Tree.json")',
            cache:false,
            dataType:"json",
            success:function (data){
                var zNodes = eval(data.tree);
                var zTree = $.fn.zTree.init($("#tree"), setting, zNodes);
                var id = GetCookie('id');           //模板编码
                $.post('@Url.Content("~/History/GetZtree")', { id: id }, function (data) {
                    point = data.tree;
                    console.log("页面刚加载时获取的point值:", point);
                    var _nodesplit = data.tree.split(',');
                    var treeObj = $.fn.zTree.getZTreeObj("tree");
                    for (var i = 0; i < _nodesplit.length; i++) {

                        var _node = treeObj.getNodeByParam("id", _nodesplit[i], null);

                        treeObj.checkNode(_node, true, true);

                        var parent = _node.getParentNode();
                        if (!parent.open) {
                            treeObj.expandNode(parent, true, true);
                        }
                    }

                }, 'json');
            }
        });
        }

        function GetLineY(list) {
            $('#container').highcharts({
                chart: {
                    type: 'spline'
                },
                title: {
                    text: 'Trend Curve Chart'//标题
                },
                subtitle: {
                    text: ''//副标题
                },
                xAxis: {
                    type: 'datetime',
                    labels: {
                        overflow: 'justify'
                    }
                },
                yAxis: {
                    title: {
                        text: ''//Y轴标题
                    },
                    //min: '',
                    //max: '',
                    minorGridLineWidth: 0,
                    gridLineWidth: 0,
                    alternateGridColor: null
                },
                tooltip: {
                    valueSuffix: ' m/s', shared: true
                },
                plotOptions: {
                    spline: {
                        lineWidth: 0.4,
                        states: {
                            hover: {
                                lineWidth: 0.5
                            }
                        },
                        marker: {
                            enabled: false
                        },
                        pointInterval: 3600000, // one hour
                        pointStart: Date.UTC(2009, 9, 6, 0, 0, 0)
                    }
                },
                series: list.list,
                navigation: {
                    menuItemStyle: {
                        fontSize: '10px'
                    }
                }
            });
        }

        //趋势显示
        function GetLine(list) {
            var highchartsOptions = Highcharts.setOptions(Highcharts.theme);
            if (list != null) {
                chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'container',
                        type: 'spline',
                        zoomType: 'x',
                        events: {
                            click: function () {
                                ////清空已选数据
                                //$("#txtFormula").val('');

                                //var box = 300;
                                //var th = $(window).height() / 2.5 - 150;
                                //var rw = $(window).width() / 2 - 200;
                                //$("#dv_Formula").animate({ top: $(window).height() / 2, opacity: 'hide', width: 0, height: 0, left: $(window).width() / 2 }, 0);
                                //$("#dv_Formula").animate({ top: th, opacity: 'show', width: 600, height: 360, left: rw }, 500);
                                //$('#dialogBg').fadeIn();
                            }
                        }
                    },
                    title: {
                        text: list.title
                    },
                    exporting: {
                        enabled: false //用来设置是否显示‘打印’,'导出'等功能按钮，不设置时默认为显示
                    },
                    xAxis: {
                        type: 'datetime',
                        labels: {
                            formatter: function () {
                                return Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.value);
                            }
                        }
                    },
                    colors: ['#058DC7', '#50B432', '#ED561B', '#DDDF00', '#24CBE5', '#64E572', '#FF9655', '#FFF263', '#6AF9C4'],
                    yAxis: list.yAxis,
                    tooltip: {
                        xDateFormat: '<b>' + '%Y-%m-%d %H:%M:%S' + '</b>',
                        crosshairs: {
                            width: 2,
                            color: 'red'
                        },
                        shared: true
                    },
                    plotOptions: {
                        spline: {
                            lineWidth: 2,
                            states: {
                                hover: {
                                    lineWidth: 2.5
                                }
                            },
                            marker: {
                                enabled: false
                            }
                        }
                    },
                    //exporting: {
                    //    enabled: false
                    //},
                    exporting:
                    {
                        buttons: {    //配置按钮选项
                            printButton: {    //配置打印按钮
                                width: 50,
                                symbolSize: 20,
                                borderWidth: 2,
                                borderRadius: 0,
                                hoverBorderColor: 'red',
                                height: 30,
                                symbolX: 25,
                                symbolY: 15,
                                x: -200,
                                y: 20
                            },
                            exportButton: {    //配置导出按钮
                                width: 50,
                                symbolSize: 20,
                                borderWidth: 2,
                                borderRadius: 0,
                                hoverBorderColor: 'red',
                                height: 30,
                                symbolX: 25,
                                symbolY: 15,
                                x: -150,
                                y: 20
                            },
                        },
                        filename: '52wulian.org',//导出的文件名
                        type: 'image/png',//导出的文件类型
                        width: 800    //导出的文件宽度
                    },
                    credits: {
                        enabled: false
                    },
                    series: list.list
                });
            }
            else {
                chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'container',
                        type: 'spline'
                    },
                    title: {
                        text: '趋势呈现数据图'
                    },
                    xAxis: {
                        type: 'datetime'
                    },
                    exporting: {
                        enabled: false //用来设置是否显示‘打印’,'导出'等功能按钮，不设置时默认为显示
                    },
                    yAxis: {
                        title: {
                            text: ''
                        },
                        min: 0
                    }
                });
            }
        }

        function GetTable(tb) {
            $("#dv_table").html(tb);
        }


        function GetCookie(objName) {//获取指定名称的cookie的值
            var arrStr = document.cookie.split("; ");
            for (var i = 0; i < arrStr.length; i++) {
                var temp = arrStr[i].split("=");
                if (temp[0] == objName) return unescape(temp[1]);
            }
        }

        //弹出隐藏层
        function ShowDiv(show_div, bg_div, point, name) {
            var box = 300;
            var th = $(window).height() / 2 - 150;
            var rw = $(window).width() / 2 - 200;
            //$("#dv_Load_body").animate({ top: th, opacity: 'show', width: 400, height: 300, left: rw }, 500);
            $("#dv_Load_body").fadeIn();
            $('#dialogBg').fadeIn();
            if ($("#eDate").val() != '' && $("#sDate").val() != '') {
                if (point != '') {
                    $.post('@Url.Content("~/History/LineShow")', { mid: templeteID, point: point, name: name, num: 3, count: $("#txt_jiange").val(), st: $("#sDate").val(), et: $("#eDate").val(), type: $("#sec_jiange").val(), fConnect: $("#fla_connect").val(), fTitle: $("#fla_title").val() }, function (data) {
                        GetLine(data);
                        GetTable(data.tb);
                        dataPointList = eval(data);
                        dataPointList.tb = "";
                        CloseDiv('dv_Load_body', 'dv_Save');
                        $("#dv_Formula_left_list").html(data.formula);
                        console.log("showDiv formula:", data.formula);
                        console.log("point: ", point);

                        dataSource = eval(data.formula);
                        updateDataSourceList(dataSource);
                    }, 'json');
                }
            }
            else
                alert('查询时间不能为空!');
        };
        //关闭弹出层
        function CloseDiv(show_div, bg_div) {
            $('#dialogBg').fadeOut();
            w = $(window).width() / 2;
            h = $(window).height() / 2;
            $("#" + show_div).animate({ top: h, opacity: 'hide', width: 0, height: 0, left: w }, 500);

            $("#txtFormula").val('');
            /*关闭弹出层时  重新绘制趋势*/

            var treeObj = $.fn.zTree.getZTreeObj("tree");
            var nodes = treeObj.getCheckedNodes(true);
            var b = '';
            for (var i = 0; i < nodes.length; i++) {
                b += nodes[i].name + ",";
            }

            if (show_div == 'dv_Formula') {
                if (checkVal == 0)
                    $.post('@Url.Content("~/History/Redreaw")', { name: $("#fla_connect").val(), fTitle: $("#fla_title").val(), title: '', sTime: $("#sDate").val(), jg: $("#txt_jiange").val() }, function (data) {
                        checkVal = 0;
                        GetLine(data);
                        GetTable(data.tb);
                    }, 'json');
                else                     /*当删除公式时，请求该方法*/
                    $.post('@Url.Content("~/History/Redreaw")', { name: $("#fla_connect").val(), fTitle: $("#fla_title").val(), title: $("#txtTitle").val(), sTime: $("#sDate").val(), jg: $("#txt_jiange").val(), point: b }, function (data) {
                        checkVal = 0;
                        GetLine(data);
                        GetTable(data.tb);
                    }, 'json');
            }
        };
        var w, h, className;
        function getSrceenWH() {
            w = $(window).width();
            h = $(window).height();
            $('#dialogBg').width(w).height(h);
        }

        window.onresize = function () {
            getSrceenWH();
        }
        $(window).resize();

        function Data() {

            var data = new Date();
            var year = data.getFullYear(); //获取完整的年份(4位,1970-????)
            var month = data.getMonth() + 1;  //获取当前月份(0-11,0代表1月)
            var day = data.getDate();

            $("#sDate").val(year + '-' + month + '-' + day + ' 0:00:00');
            $("#eDate").val(year + '-' + month + '-' + day + ' ' + data.getHours() + ':00:00');
        }

        function RegChartRightClickEvents() {
            document.oncontextmenu = false;
            ////图表容器的右键鼠标事件
            //$("#container").bind("mouseup", function (oEvent) {
            //    if (!oEvent) oEvent = window.event;
            //    if (oEvent.button == 2) {

            //        //var box = 300;
            //        //var th = $(window).height() / 2.5 - 150;
            //        //var rw = $(window).width() / 2 - 200;
            //        //$("#dv_Formula").animate({ top: $(window).height() / 2, opacity: 'hide', width: 0, height: 0, left: $(window).width() / 2 }, 0);
            //        //$("#dv_Formula").animate({ top: th, opacity: 'show', width: 400, height: 300, left: rw }, 500);
            //        //$('#dialogBg').fadeIn();

            //    }
            //});
        }
        function addValue(val) {
            alert(val);
            $("#txtFormula").val($("#txtFormula").val() + "'" + val + "'");
        }
        /*公式删除*/
        function DelFormula(obj, id, formula, title, cid) {

            $("#txtTitle").val(title);

            formula = formula.replace(/~/g, "'");
            $("#txtFormula").val(formula);

            $("#dis_id").val(cid);              /*模板编码*/
            $("#dis_title").val(title);         /*公式标题*/
            $("#dis_formula").val(formula);     /*公式内容*/


            checkVal = 1;
            $.post('@Url.Content("~/History/GetFormula")', { query: 'del', fTitle: $("#fla_title").val(), fConnect: $("#fla_connect").val(), title: $("#txtTitle").val(), name: $("#txtFormula").val() }, function (data) {
                $("#dv_list").html(data.formulaList);
                $("#fla_title").val(data.formulaTitle);
                $("#fla_connect").val(data.formulaConnect);
            }, 'json');
        }
        function EditFormula(obj, id, formula, title, cid) {
            $("#txtTitle").val(title);

            formula = formula.replace(/~/g, "'");
            $("#txtFormula").val(formula);

            $("#dis_id").val(cid);              /*模板编码*/
            $("#dis_title").val(title);         /*公式标题*/
            $("#dis_formula").val(formula);     /*公式内容*/
        }
        var typeBtn = '';
        function EditFormulaDbl(id, formula, title, cid) {
            typeBtn = 'edit';
            /*ID 为模板ID*/
            $("#dv_Operate").hide();
            $("#dv_Formula_right").hide();
            $("#dv_Formula_left_add").show();
            $("#dv_Formula_right_add").show();

            $("#txtTitle").val(title);

            formula = formula.replace(/~/g, "'");
            $("#txtFormula").val(formula);

            $("#dis_id").val(cid);              /*模板编码*/
            $("#dis_title").val(title);         /*公式标题*/
            $("#dis_formula").val(formula);     /*公式内容*/
        }

        function mouseClick(obj) {
            clearClickClass();
            if (obj.className == "tr_over_1" || obj.className == "tr_1")
                obj.className = "tr_foucs_1";
            else if (obj.className == "tr_over_2" || obj.className == "tr_2")
                obj.className = "tr_foucs_2";
        }

        function clearClickClass() {
            $('table').find('tr').each(function () {
                if ($(this).attr('class') == "tr_foucs_1")
                    $(this).attr('class', 'tr_1');
                else if ($(this).attr('class') == "tr_foucs_2")
                    $(this).attr('class', 'tr_2');
            });
        }

            $("#btn_line").css("background-image", "url(../../Content/img/Map/map_trend_click.png)");
            $("#btn_table").css("background-image", "url(../../Content/img/Map/map_table.png)");
            $("#btn_line").click(function () {
                $("#dv_table").hide();
                $("#container").show();
                $("#btn_line").css("background-image", "url(../../Content/img/Map/map_trend_click.png)");
                $("#btn_table").css("background-image", "url(../../Content/img/Map/map_table.png)");
            });
            $("#btn_table").click(function () {
                $("#dv_table").show();
                $("#container").hide();
                $("#btn_line").css("background-image", "url(../../Content/img/Map/map_trend.png)");
                $("#btn_table").css("background-image", "url(../../Content/img/Map/map_table_click.png)");
            });

            $("#btn_chart_show").click(function () {    //查询
                var ts = '请先选择测点在进行查询!';

                var treeObj = $.fn.zTree.getZTreeObj("tree");
                var nodes = treeObj.getCheckedNodes(true);

                point = '', name = '', pid = '';

                for (var i = 0; i < nodes.length; i++) {
                    point += nodes[i].nodeID + ',';
                    name += nodes[i].name + ',';
                    pid += nodes[i].pid + ',';
                }

                name = name.substring(0, name.length - 1);
                point = point.substring(0, point.length - 1);
                pid = pid.substring(0, pid.length - 1);

                if (point != '') {
                    $.post('@Url.Content("~/History/LineShow")', { mid: templeteID, point: point, name: name, num: 3, count: $("#txt_jiange").val(), st: $("#sDate").val(), et: $("#eDate").val(), type: $("#sec_jiange").val(), fConnect: $("#fla_connect").val(), fTitle: $("#fla_title").val() }, function (data) {
                        GetLine(data);
                        GetTable(data.tb);
                        CloseDiv('dv_Load_body', 'dv_Save');
                        $("#dv_Formula_left_list").html(data.formula);
                    }, 'json');
                } else
                {
                    $("#dv_Formula_left_list").html("");
                    alert(ts);
                }

            });

            $("#btn_back").click(function () {
                window.location.href = "@Url.Content("~/History/CustomTrend")";
            });

            $("#btn_print").click(function () {
                $.post('@Url.Content("~/History/Print")', {}, function (data) {
                    alert(data);
                }, 'json');
            });

            /* 公式删除 */
            $("#btn_Del").click(function () {
                checkVal = 1;
                $.post('@Url.Content("~/History/GetFormula")', { query: 'del', fTitle: $("#fla_title").val(), fConnect: $("#fla_connect").val(), title: $("#txtTitle").val(), name: $("#txtFormula").val() }, function (data) {
                    $("#dv_list").html(data.formulaList);
                    $("#fla_title").val(data.formulaTitle);
                    $("#fla_connect").val(data.formulaConnect);
                }, 'json');
            });
            /* 公式编辑 */
            

            $("#btn_Formula").click(function () {
                $('#dialogBg').fadeIn();
                $("#dv_formula").show();
                $("#dv_formula_show").fadeIn();
                //
                updateDataSourceList(dataSource);
                //var tableData = "";
                //console.log("point:", point);
                //var pointArray = point.split(",");
                //console.log(pointArray);
                
                @*$.post('@Url.Content("~/History/LineShow")',
                    {
                        point: point,
                        name: name,
                        num: 3,
                        count: $("#txt_jiange").val(),
                        st: $("#sDate").val(),
                        et: $("#eDate").val(),
                        type: $("#sec_jiange").val(),
                        fConnect: $("#fla_connect").val(),
                        fTitle: $("#fla_title").val()
                    },
                    function (data) {
                        // console.log("data:", data);
                        console.log("dataSource:", data.formula);
                        tableData = eval(data.formula);
                        //GetLine(data);
                        //GetTable(data.tb);
                        //CloseDiv('dv_Load_body', 'dv_Save');
                        //$("#dv_Formula_left_list").html(data.formula);
                        // 更新数据源列表，且处理 dataSource
                        dataSource = updateDataSourceList(tableData);

                },'json');*@
            });

            //$("#btn_Formula").click(function () {

            //    $("#text_search").text('Formula List');
            //    $("#dv_Operate").show();
            //    $("#dv_Formula_right").show();
            //    $("#dv_Formula_left_add").hide();
            //    $("#dv_Formula_right_add").hide();

            //    var box = 300;
            //    var th = $(window).height() / 2 -250;
            //    var rw = $(window).width() / 2 - 500;
            //    $("#dv_Formula").animate({ top: th, opacity: 'show', width: 1000, height: 500, left: rw }, 500);
            //    $('#dialogBg').fadeIn();
            //});


            /*公式添加*/
            $("#btn_Add").click(function () {

                //清空已选数据
                $("#txtFormula").val('');
                $("#txtTitle").val('');

                $("#text_search").text('Formula Calculator');

                $("#dv_Operate").hide();
                $("#dv_Formula_right").hide();


                $("#dv_formula_modify").show();
                //$("#dv_Formula_left_add").show();
                //$("#dv_Formula_right_add").show();

                typeBtn = 'add';

                //CloseDiv('dv_Formula', '');
            });

            /*公式 添加  编辑  不操作数据库*/
            $("#btn_Save_Formula").click(function () {
                if (typeBtn == 'edit') {
                    /*编辑公式*/

                    $.post('@Url.Content("~/History/GetFormula")', { query: 'edit', fTitle: $("#fla_title").val(), fConnect: $("#fla_connect").val(), oleTitle: $("#dis_title").val(), oldFormula: $("#dis_formula").val(), title: $("#txtTitle").val(), name: $("#txtFormula").val() }, function (data) {
                        //GetLine(data);
                        $("#dv_list").html(data.formulaList);

                        $("#fla_title").val(data.formulaTitle);
                        $("#fla_connect").val(data.formulaConnect);

                        $("#dv_Operate").show();
                        $("#dv_Formula_right").show();
                        $("#dv_Formula_left_add").hide();
                        $("#dv_Formula_right_add").hide();

                        $("#txtTitle").val('');
                    }, 'json');


                } else if (typeBtn == 'add') {
                    /*增加公式不操作数据库*/

                    $("#dis_con").val($("#txtFormula").val() + "~" + $("#dis_con").val());
                    $("#dis_name").val($("#txtTitle").val() + "~" + $("#dis_name").val());

                    $.post('@Url.Content("~/History/GetFormula")', { query: 'add', title: $("#txtTitle").val(), name: $("#txtFormula").val(), fTitle: $("#fla_title").val(), fConnect: $("#fla_connect").val() }, function (data) {
                        //GetLine(data);
                        $("#dv_list").html(data.formulaList);

                        $("#fla_title").val(data.formulaTitle);
                        $("#fla_connect").val(data.formulaConnect);

                        $("#dv_Operate").show();
                        $("#dv_Formula_right").show();
                        $("#dv_Formula_left_add").hide();
                        $("#dv_Formula_right_add").hide();
                    }, 'json');
                }
            });

            $("#btn_Save_Model").click(function () {

                var treeObj = $.fn.zTree.getZTreeObj("tree");
                var nodes = treeObj.getCheckedNodes(true);
                var v = "";
                for (var i = 0; i < nodes.length; i++) {
                    v += nodes[i].id + ",";
                }

                $.post('@Url.Content("~/History/AddModel")', { id: v, name: $("#txtName").val(), formulaName: $("#fla_title").val(), formulaConnect: $("#fla_connect").val() }, function (data) {

                    if (data.result = true) {
                        alert('模板保存成功!');
                        CloseDiv('dv_Save_body', 'dv_Save');
                    }
                    else
                        alert('模板保存失败!');
                }, 'json');
            });
            //RegChartRightClickEvents();



                // 记录输入框中的光标位置
                var anchorNode = $("#dis_output_formula")[0];
                var anchorOffset = 0;

                // 自动聚焦
                anchorNode.focus();

                // 创建 DOM 范围来操纵 DOM
                var insertRange = document.createRange();

                // 存储了已选节点的所有信息：数据源，名称和值
                var dataSource = {};

                // 存储了所有公式信息
                var dataFormula = [];

                // 存储了绘制当前公式所需要的节点数据
                var dataPointList = {};
                var dataPointFormula = {};

                // 当前正在操作的公式 id
                var formulaID = "";
                // 画线所用颜色数组
                var lineColor = ["#058DC7", "#50B432", "#ED561B", "#DDDF00", "#24CBE5", "#64E572", "#FF9655", "#FFF263", "#6AF9C4", "#6AF9C6", "#6AF9C5", "#6AF9C7", "#6AF9C8", "#6AF9C9", "#6AF9D4", "#6AF9D9", "#6AF9D8", "#6AF9D7", "#6AF9D6", "#6AF9D5", "#6AF9D3", "#6AF9D2", "#6AF9D1"];

                /* 输入按钮点击事件
                 *
                 *
                 */
                $(".dis_input_btn").on("click", function (event) {
                    // console.log (anchorOffset);
                    // 根据点击的按钮来获取要输入的内容
                    var output = this.id.substr(this.id.length - 1);
                    // 如果点击的是 + - × ÷ ( ) 的话，再结果前后加空格
                    if (Array.prototype.slice.apply(event.target.classList).indexOf("dis_input_btn_punc") > 0) {
                        output = " " + output + " ";
                    }
                    insertIntoOutputFormula(output);
                    // 自动聚焦
                    // $("#dis_output_formula").focus();
                });

                /* 点击数据源列表向公式框中添加数据源节点
                 */
                $("#station_list_content").on("click", function (event) {

                //$("#station_list_content tr td").on("click", function (event) {
                    // 获取当前点击事件
                    var target = event.target;
                    // 初始化输出内容
                    // var output = "<span class = 'dis_output_source' contenteditable = 'false'>#";
                    var output = " ";
                    // 判断如果点击的是 数据源 这一列，则直接获取其数据源编号，如果不是，则顺着 tr 找到此行的数据源编号。
                    if (target.className != "station_list_content_name") {
                        output += target.parentElement.children[1].innerText;
                    }
                    else {
                        output += target.innerText;
                    }
                    output += " ";
                    // 准备向公式显示区输入
                    formulaContentDOM = $("#dis_output_formula");

                    insertIntoOutputFormula(output);

                });




                // 在每次输入框失去焦点时，更新 anchorNode 和 anchorOffset 的值，便于下次插入时从光标位置插入。
                $("#dis_output_formula").on("blur", function (event) {
                    // 当公式显示区失去焦点的时候，获取失焦前的光标所在位置，之后的内容要从其中插入。
                    anchorNode = window.getSelection().anchorNode;
                    anchorOffset = window.getSelection().anchorOffset;


                });

                // 根据光标位置插入内容，同时更新公式显示区显示和公式显示区 value
                // 参数：
                // outputFormula 公式显示区显示内容
                // outputValue 公式显示区 value
                function insertIntoOutputFormula(outputFormula, outputValue) {
                    // 准备向公式显示区输入
                    formulaContentNode = $("#dis_output_formula");
                    // 获取公式显示区中的 HTML 文档字符串
                    var formulaContentDOM = formulaContentNode.text();
                    var formulaContentData = formulaContentNode.data("value");
                    // 对字符串进行处理，从 anchorOffset 处将字符串切开
                    var strTemp1 = formulaContentDOM.slice(0, anchorOffset);
                    var strTemp2 = formulaContentDOM.slice(anchorOffset);
                    // 更新 anchorOffset 的值
                    anchorOffset += outputFormula.length;
                    // 拼装输出的 HTML 字符串
                    outputFormula = strTemp1 + outputFormula + strTemp2;
                    // 将拼装好的字符串写入公式显示区
                    formulaContentNode.text(outputFormula);
                    // console.log (outputFormula);
                }

                // 点击数学公式列表，将数学公式填入输入框
                $("#math_formula tr td").on("click", function () {
                    console.log(this.innerText);
                    insertIntoOutputFormula(this.innerText);
                });
                // !!!
                // 在数学公式列表里悬浮或者点击时，显示相关公式的介绍
                $("#math_formula").on ("mouseover click", function (event) {
                    target = event.target;
                    if (target.nodeName == "TD")  {
                        $("#dis_formula_intro")[0].innerText = mathFormula[target.innerText];
                    }
                });

                // 监听公式显示区的变化，并将计算结果输出到预览区
                $("#dis_output_formula").bind('DOMSubtreeModified', function (e) {
                    var formulaText = $(e.target).text();
                    // var formulaTextNoNbsp = formulaText.replace();
                    // 正则表达式说明，要匹配的结果中
                    // 1. 不能是纯数字，防止对正常的数字计算进行干扰
                    // 2. 不能是运算符
                    // 3. 不能是 sin, cos, tan 等特殊运算符
                    // 4. 应该是一串包含汉字，可能包含数字字母的字符串
                    // 先替换不符合规则的 - 
                    var formulaTextPreTreat = formulaText.replace(/(\s-\s)/g, function (match) {
                        return "&";
                    });
                    // 进行公式的转换
                    var formulaTextRep = formulaTextPreTreat.replace(/(?![0-9a-z ]+)([\u4e00-\u9fa5\w-#:（） ]+)/g, function (match) {
                        // 过滤掉结尾的空格
                        var matchNoNbsp = match.replace(/(^ *)|( *$)/g, "");
                        for (var i = 0, len = dataSource.length; i < len; i++) {
                            if (dataSource[i].name == matchNoNbsp)
                                return dataSource[i].value;
                        }
                    });
                    // 将替换成 & 的 - 换回来
                    var formulaResult = formulaTextRep.replace(/\&+/g, function (match) {
                        return "-";
                    });
                    try {
                        var formulaTextRepNoNbsp = formulaResult.replace(/\s/g, "");
                        var calResult = math.format(math.eval(formulaTextRepNoNbsp), 7);
                        // console.log (calResult);

                        if (calResult === "undefined")
                            $("#dis_output_result_cal").text("NaN");
                        else
                            $("#dis_output_result_cal").text(calResult);
                    } catch (e) {
                        // console.log (e.name, e.message);
                        $("#dis_output_result_cal").text("NaN");

                    }

                });


                // 各个按钮的点击事件
                // 公式列表页的 新建 按钮
                $("#dv_operate_btn_add").on("click", function () {
                    var pointArr = point.split(",");
                    if (pointArr.length + dataFormula.length < 9) {
                        formulaID = Date.now().toString();
                        $('#dv_formula_show').hide();
                        $('#dv_formula_modify').show();
                    }
                    else {
                        alert("所选测点数与公式数不能超过9个");
                    }
                });
                // 公式列表页的 修改 删除 按钮
                $("#formula_list_content").on("click", function (event) {
                    var target = event.target;
                    // 根据点击的单元行获取公式的 id
                    formulaID = target.parentElement.parentElement.firstElementChild.innerText;

                    // 公式编辑界面
                    if (target.className == "formula_list_content_modify") {
                        // 布置编辑界面
                        $("#dis_output_formula")[0].innerText = getFromFormulaList(dataFormula, formulaID, "desc");
                        $("#confirm_formula_title").val(getFromFormulaList(dataFormula, formulaID, "title"));
                        // 根据需求来获取其数据源的值
                        var formulaPoint = getFromFormulaList(dataFormula, formulaID, "point");
                        var formulaPointArray = formulaPoint.split(",");
                        for (var i = 0, leni = dataSource.length; i < leni; i++) {
                            for (var j = 0, lenj = formulaPointArray.length; j < lenj; j++) {
                                if (dataSource[i].para == formulaPointArray[j]) {
                                    formulaPointArray.splice(j, 1);
                                    // j--;
                                    break;
                                }
                            }

                        }
                        
                        console.log("formulaPointArray:", formulaPointArray);
                        if (formulaPointArray.length > 0) {
                            formulaPointStr = formulaPointArray.join(",");
                            // var ajaxData = JSON.stringify(formulaPointStr);
                            $.ajax({
                                url: '@Url.Content("~/History/GetPointsData")',
                                data: { pointid: formulaPointStr },
                                type: 'POST',
                                success: function (jsonData) {
                                    //var data = eval(jsonData);
                                    //console.log("点按编辑按钮之后传来的 pointdata:", data);
                                    //var nameArray = data.split(",");
                                    //for (var i = 0, leni = dataSource.length; i < leni; i++) {
                                    //    for (var j = 0, lenj = formulaPointArray.length; j < lenj; j++) {
                                    //        if (dataSource)
                                    //            dataSource.push();
                                    //    }
                                    //}
                                    //updateDataSourceList();
                                    var data = eval(jsonData.tree);
                                    dataSource = dataSource.concat(data);
                                    // dataSource.push(data);
                                    updateDataSourceList(dataSource);
                                },
                                error: function () {

                                }
                            });
                        }
                        $("#dv_formula_show").hide();
                        $("#dv_formula_modify").show();
                    }
                    // 公式删除界面
                    else if (target.className == "formula_list_content_del") {
                        if (templeteID) {
                            $.ajax({
                                url: '@Url.Content("~/History/DelFormula")',
                                data: { fid: formulaID },
                                type: 'POST',
                                success: function (judge) {
                                    console.log("judge:", judge);
                                    if (judge) {
                                        for (var i = 0, len = dataPointList.list.length; i < len; i++) {
                                            if (dataPointList.list[i].name == getFromFormulaList(dataFormula, formulaID, "title")) {
                                                dataPointList.list.splice(i, 1);
                                                dataPointList.yAxis.splice(i, 1);
                                            }
                                        }
                                        delInForlumaList(dataFormula, formulaID);
                                        updateFormulaList(dataFormula);
                                    }
                                    else {
                                        console.log("数据库故障");
                                    }
                                },
                                error: function (error) {
                                    console.log(error);
                                }
                            });
                        }
                        else {
                            for (var i = 0, len = dataPointList.list.length; i < len; i++) {
                                if (dataPointList.list[i].name == getFromFormulaList(dataFormula, formulaID, "title")) {
                                    dataPointList.list.splice(i, 1);
                                    dataPointList.yAxis.splice(i, 1);
                                }

                            }
                            delInForlumaList(dataFormula, formulaID);
                            updateFormulaList(dataFormula);
                        }

                    }
                });
                // 公式列表页的 取消 按钮
                // 公式列表页的 X 按钮
                $("#dv_operate_btn_cancel, #dv_formula_show_close").on("click", function () {
                    $('#dv_formula_show').fadeOut();
                    $("#dv_formula").fadeOut();
                    $('#dialogBg').fadeOut();
                    var checkArr = $("#formula_list_content tr .formula_list_content_check .formula_list_content_check_val");
                    var flag = 0;
                    for (var i = 0, len = checkArr.length; i < len; i++) {
                        if (checkArr[i].checked) {
                            flag = 1;
                        }
                        else {
                            flag = 0;
                        }
                        setFormulaList(dataFormula, dataFormula[i].id, "check", flag);
                    }
                    // 展示公式
                    for (var i = 0, len = dataFormula.length; i < len; i++) {
                        
                        if (dataFormula[i].check == 1) {
                            var flag = true;
                            for (var j = 0, lenj = dataPointList.list.length; j < lenj; j++) {
                                // 表示 当前节点已存在 
                                if (dataFormula[i].title == dataPointList.list[j].name) {
                                    flag = false;
                                    dataPointList.list[j].data = formulaCal(dataFormula[i].desc, dataPointList);
                                }
                            }
                            if (flag == true) {
                                var listItem = {};
                                var resultList = formulaCal(dataFormula[i].desc, dataPointList);
                                listItem["data"] = resultList;
                                listItem["name"] = dataFormula[i].title;
                                listItem["yAxis"] = dataPointList.list[dataPointList.list.length - 1].yAxis + 1;
                                listItem["_colorIndex"] = listItem["yAxis"];
                                listItem["_symbolIndex"] = listItem["yAxis"];

                                var yAxisItem = {};
                                yAxisItem["lineColor"] = lineColor.slice(dataPointList.yAxis.length, dataPointList.yAxis.length + 1).join("");
                                yAxisItem["lineWidth"] = 1;
                                yAxisItem["title"] = "{text:''}";
                                yAxisItem["index"] = dataPointList.yAxis.length;

                                dataPointList.list.push(listItem);
                                dataPointList.yAxis.push(yAxisItem);
                            }
                        }
                        else {
                            for (var j = 0, lenj = dataPointList.list.length; j < lenj; j++) {
                                if (dataFormula[i].title == dataPointList.list[j].name) {
                                    dataPointList.list.splice(j, 1);
                                    dataPointList.yAxis.splice(j, 1);
                                }
                            }
                        }
                    }
                    console.log("画图前的dataPointList", dataPointList);
                    // huatu
                    GetLine(dataPointList);

                    //////
                });

                // 公式编辑页的 保存 按钮
                $("#dis_operate_btn_save").on("click", function () {
                    var temp = $("#dis_output_formula");
                    $("#dialog_confirm_body_formula")[0].innerText = temp[0].innerText;
                    $("#dialogBg_confirm").show();
                    $("#dv_formula_confirm").show();
                    $("#confirm_formula_title").focus();
                });

                // 公式编辑页的 取消 按钮
                // 公式编辑页的 X 按钮
                $("#dis_operate_btn_cancel, #dv_formula_modify_close").on("click", function () {
                    $("#dis_output_formula").text("");
                    $("#confirm_formula_title").val("");
                    $('#dv_formula_modify').hide();
                    $('#dv_formula_show').show();
                });

                // 公式确认页的 确认 按钮
                //
                $("#confirm_btn_save").on("click", function () {
                    var formulaDesc = $("#dialog_confirm_body_formula")[0].innerText;
                    var formulaPointArray = [];
                    var formulaText = $("#dialog_confirm_body_formula")[0].innerText;
                    // 先替换不符合规则的 - 
                    var formulaTextPreTreat = formulaText.replace(/(\s-\s)/g, function (match) {
                        return "&";
                    });
                    // 进行公式的转换
                    var formulaTextRep = formulaTextPreTreat.replace(/(?![0-9a-z ]+)([\u4e00-\u9fa5\w-#: ]+)/g, function (match) {
                        // 过滤掉结尾的空格
                        var matchNoNbsp = match.replace(/ *$/g, "");
                        for (var i = 0, len = dataSource.length; i < len; i++) {
                            if (dataSource[i].name == matchNoNbsp) {
                                if (formulaPointArray.length == 0) {
                                    formulaPointArray.push(dataSource[i].para);
                                    return dataSource[i].para;
                                }
                                for (var j = 0; j < formulaPointArray.length; j++) {
                                    if (formulaPointArray[j] == dataSource[i].para) {
                                        break;
                                    }
                                    formulaPointArray.push(dataSource[i].para);
                                    return dataSource[i].para;

                                }
                            }
                        }
                    });
                    // 将替换成 & 的 - 换回来
                    var formulaResult = formulaTextRep.replace(/\&+/g, function (match) {
                        return "-";
                    });
                    var formulaTextRepNoNbsp = formulaResult.replace(/\s/g, "");

                    // 拼装公式数据 data
                    var data = {
                        "title": $("#confirm_formula_title").val(),
                        "content": formulaTextRepNoNbsp,
                        "desc": formulaDesc, "id": formulaID,
                        "point": formulaPointArray.join(","),
                        "check": 0
                    };
                    console.log("单条公式的存储结果:", data);

                    // 隐藏确认、编辑对话框以及背景
                    $("#dialogBg_confirm").hide();
                    $("#dv_formula_confirm").hide();
                    $("#dv_formula_modify").hide();
                    // 清空输入
                    $("#dis_output_formula")[0].innerText = "";
                    $("#confirm_formula_title").val("");
                    // 显示公式列表界面
                    $("#dv_formula_show").show();

                    for (var i = 0, len = dataFormula.length; i < len; i++) {
                        // 状态为编辑
                        if (dataFormula[i].id == formulaID) {
                            setFormulaList(dataFormula, formulaID, "title", data.title);
                            setFormulaList(dataFormula, formulaID, "content", data.content);
                            setFormulaList(dataFormula, formulaID, "desc", data.desc);
                            //setFormulaList(dataFormula, formulaID, "point", data.point);

                            // 使用 updateFormulaList 方法更新公式列表页
                            updateFormulaList(dataFormula);
                            console.log("dataFormula:", dataFormula);
                            return;
                        }
                    }
                    // 在已存在的公式列表中没有找到该 id 的相关信息，所以状态为新增
                    // 将新建的公式插入公式列表信息中
                    dataFormula.push(data);
                    // 使用 updateFormulaList 方法更新公式列表页
                    updateFormulaList(dataFormula);
                    console.log("dataFormula:", dataFormula);
                });

                // 公式确认页的 取消 按钮
                //
                $("#confirm_btn_cancel").on("click", function () {
                    $("#dialogBg_confirm").hide();
                    $("#dv_formula_confirm").hide();
                });

                // 根据数据源信息 tableData 更新数据源列表，并且返回处理后的 数据源信息
                function updateDataSourceList(dataSource) {
                    if (dataSource) {
                        var formulaTable = "";
                        for (var i = 0, len = dataSource.length; i < len; i++) {
                            formulaTable += '<tr><td class = "station_list_content_data">' + (i + 1) + '</td><td class = "station_list_content_name">' + dataSource[i].name + '</td><td class = "station_list_content_value">' + dataSource[i].value + '</td></tr>';
                            // var tempObj = { "para": tableData[i].para, "value": tableData[i].value };
                            // dataSource[tableData[i].name] = tempObj;
                        }
                        // console.log ("formulaTable", formulaTable);
                        // console.log("每一次更新数据时的 dataSource", dataSource);
                        $("#station_list_content").html(formulaTable);
                        // return dataSource;
                    }
                }

                /** 根据公式 id 从公式信息 dataFormula 选出特定公式中设置 setSth 所指定的setValue
                     *  formulaID 表示要操作的公式 id
                     *  setSth 表示要设置的公式项
                     *  setValue 表示要设置的公式项的值
                     */
                function setFormulaList(dataFormula, formulaID, setSth, setValue) {
                    try {
                        for (var i = 0, len = dataFormula.length; i < len; i++) {
                            if (dataFormula[i].id == formulaID) {
                                dataFormula[i][setSth] = setValue;
                            }
                        }
                    } catch (e) {
                        console.error("设置公式信息指定参数错误", e.name);
                    };
                }


                /** 根据公式 id 从公式信息 dataFormula 中获取 getSth 所指定的信息并返回
                 *  formulaID 表示要操作的公式 id
                 *  getSth 表示要取到的公式项
                 */
                function getFromFormulaList(dataFormula, formulaID, getSth) {
                    try {
                        for (var i = 0, len = dataFormula.length; i < len; i++) {
                            if (dataFormula[i].id == formulaID) {
                                return dataFormula[i][getSth];
                            }
                        }
                    } catch (e) {
                        console.error("获取公式信息指定参数错误", e.name);
                    };
                }



                /** 根据公式 id 从公式信息 dataFormula 中删除相应公式项
                 *  formulaID 表示要操作的公式 id
                 *  返回被删除的公式项对象
                 */
                function delInForlumaList(dataFormula, formulaID) {
                    try {
                        for (var i = 0, len = dataFormula.length; i < len; i++) {
                            if (dataFormula[i].id == formulaID) {
                                return dataFormula.splice(i, 1);
                            }
                        }
                    } catch (e) {
                        console.error("找不到指定的公式项");
                    }
                }

                // 根据公式信息 dataFormula 来刷新公式区
                function updateFormulaList(dataFormula) {
                    var formulaListDiv = $("#formula_list_content");
                    var formulaListHtml = "";
                    for (var i = 0, len = dataFormula.length; i < len; i++) {
                        if (dataFormula[i].check == 1) {
                            formulaListHtml += '<tr><td class="formula_list_content_id">' + dataFormula[i].id + '</td><td class="formula_list_content_name">' + dataFormula[i].title + '</td><td class="formula_list_content_formula">' + dataFormula[i].desc + '</td><td class="formula_list_content_operate"><span class = "formula_list_content_modify">编辑</span> <span class = "formula_list_content_del">删除</span></td><td class="formula_list_content_check"><input type = "checkbox" class = "formula_list_content_check_val" checked /></td></tr>';
                        }
                        else {
                            formulaListHtml += '<tr><td class="formula_list_content_id">' + dataFormula[i].id + '</td><td class="formula_list_content_name">' + dataFormula[i].title + '</td><td class="formula_list_content_formula">' + dataFormula[i].desc + '</td><td class="formula_list_content_operate"><span class = "formula_list_content_modify">编辑</span> <span class = "formula_list_content_del">删除</span></td><td class="formula_list_content_check"><input type = "checkbox" class = "formula_list_content_check_val" /></td></tr>';
                        }
                    }
                    formulaListDiv.html(formulaListHtml);
                }

                /**
                 * 根据传入的公示内容（描述），与公式节点的数据，返回一个计算好的结果数组
                 * formulaText：传入的公式描述
                 * 
                 */
                function formulaCal(formulaText, dataPointList) {
                    // 此 i 用来计数
                    var index = 0;
                    var list = dataPointList.list;
                    // 存储各节点的数据
                    var valueList = [];
                    var valueResult = [];
                    // cun X
                    var xAxis = [];
                    for (var j = 0, lenj = list[0].data.length; j < lenj; j++) {
                        xAxis.push(list[0].data[j][0]);
                    }

                    for (var i = 0, leni = list.length; i < leni; i++) {
                        var arrTempY = [];
                        var valueListItem = {};
                        for (var j = 0, lenj = list[i].data.length; j < lenj; j++) {
                            arrTempY.push(list[i].data[j][1]);
                        }
                        valueListItem["data"] = arrTempY;
                        valueListItem["name"] = list[i].name;
                        valueList.push(valueListItem);
                    }
                    console.log("valueList:", valueList)
                    // 进行公式的解析
                    var formulaTextPreTreat = formulaText.replace(/(\s-\s)/g, function (match) {
                        return "&";
                    });
                    // 进行公式的转换
                    var formulaTextRep = formulaTextPreTreat.replace(/(?![0-9a-z ]+)([\u4e00-\u9fa5\w-#:（） ]+)/g, function (match) {
                        // 过滤掉结尾的空格
                        var matchNoNbsp = match.replace(/(^ *)|( *$)/g, "");
                        for (var i = 0, len = list.length; i < len; i++) {
                            if (list[i].name == matchNoNbsp) {
                                index++;
                                var ident = "x" + index;
                                // 暂未考虑两个节点相同的情况
                                for (var j = 0, lenj = valueList.length; j < lenj; j++) {
                                    if (valueList[j].name == matchNoNbsp) {
                                        valueList[j]["ident"] = ident;
                                        return ident;
                                    }

                                }
                            }
                        }
                    });
                    // 将替换成 & 的 - 换回来
                    var formulaResult = formulaTextRep.replace(/\&+/g, function (match) {
                        return "-";
                    });

                    console.log("formulaResult:", formulaResult);

                    var formulaFinal = formulaResult.replace(/\s/g, "");
                    // x1+x2+x3

                    for (var i = 0, len = valueList[0].data.length; i < len; i++) {
                        var formulaResult = formulaFinal.replace(/x\d/g, function (match) {
                            for (var j = 0, lenj = valueList.length; j < lenj; j++) {
                                if (valueList[j].ident && valueList[j].ident == match) {
                                    return valueList[j].data[i];
                                }
                            }
                        });
                        valueResult.push(math.format(math.eval(formulaResult), 7));
                    }
                    var resultList = [];
                    for (var i = 0, len = xAxis.length; i < len; i++) {
                        resultList[i] = [xAxis[i], parseInt(valueResult[i])];
                    }
                    console.log("计算结果", resultList);
                    return resultList;
                }

                // 点击保存模板按钮方法
                $("#btn_save").click(function () {
                    var pointArr = point.split(",");
                    if ((pointArr.length + dataFormula.length) > 9) {
                        alert("所选测点数与公式数不能超过9个");
                    }
                    else {
                        $("#tem_dialog").show();
                        $('#dialogBg').fadeIn();
                        if (templeteID) {
                            $("#tem_save_input").val(templeteName);
                        }
                        else {
                        }
                    }

                });

                // 模板保存页内点击保存按钮向数据库中写入模板所有数据
                $("#tem_btn_save").on("click", function () {

                    var data = {
                        "mid": templeteID,
                        "mname": $("#tem_save_input").val(),
                        "data": dataFormula,
                        "pointid": point
                    };
                    console.log("向数据库中写入模板的所有数据:", data);
                    var ajaxData = JSON.stringify(data);
                    //console.log("ajaxData:", ajaxData);

                    $.ajax({
                        url: '@Url.Content("~/History/AddFormula")',
                        data: { jsonData: ajaxData },
                        type: 'POST',
                        dataType: 'json',
                        success: function (judge) {
                            // ajax 请求返回之后
                            // console.log(judge);
                            if (judge) {
                                $("#tem_dialog").fadeOut();
                                $("#dialogBg").fadeOut();
                            }
                            else {
                                console.log("数据库异常");
                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                });

                $("#tem_btn_cancel, #tem_btn_close").on("click", function () {
                    $("#tem_dialog").hide();
                    $("#tem_save_input").val("");
                    $('#dialogBg').fadeOut();
                });




                // 下面是一些初始化代码

                // 数学公式信息
                var mathFormula = {
                    "abs(x)": "返回给定数值的绝对值，即不带符号的数值.",
                    "cos(x)": "返回给定角度的余弦值.",
                    "exp(x)": "返回 e 的 n 次方.",
                    "floor(x)": "将数字向下舍入到最接近的整数或最接近的指定基数的倍数.",
                    "log(x)": "根据给定底数返回数字的对数.",
                    "max(value1, value2, ...)": "返回给定所有值的最大值",
                    "min(value1, value2, ...)": "返回给定所有值的最小值",
                    "sin(x)": "返回给定角度的正弦值.",
                    "tan(x)": "返回给定角度的正切值."
                };

                // 储存所有公式信息,加载公式
                updateFormulaList(dataFormula);



                function LoadData() {
                    var id = GetCookie('id');           //模板编码
                    templeteID = id;
                    templeteName = GetCookie('name');
                    console.log("templeteID:", templeteID);
                    var judge = GetCookie('yaxis');     //是否是多Y轴
                    var max = GetCookie("max");         //最大值
                    var min = GetCookie("min");         //最小值
                    var y = GetCookie("y");             //Y轴是否自动增长

                    $.ajax({
                        url: '@Url.Content("~/History/GetZtreeListInit")',
                        data: { id: id, judge: judge, max: max, min: min, y: y },
                        type: 'POST',
                        success: function (data) {

                            dataSourceJson = data.formula;
                            dataSource = eval(dataSourceJson);
                            console.log("页面刚加载时获取的原勾选的点的数据源:", dataSource);
                            dataPointList = data;
                            dataPointList.tb = "";
                            console.log("页面刚加载时获取的绘图所用数据", dataPointList);
                            // updateDataSourceList(dataSource);

                            $("#dv_list").html(data.formulaList);

                            $("#fla_title").val(data.formulaTitle);
                            $("#fla_connect").val(data.formulaConnect);

                            GetLine(data);
                            GetTable(data.tb);
                        },
                        error: function (XMLHttpRequset, textStatus, errorThrown) {
                            console.log(XMLHttpRequset);
                            console.log(textStatus);
                            console.log(errorThrown);
                        }
                    });

                    // 根据模板 id 获取该模板的公式列表
                    if (templeteID) {
                        $.ajax({
                            url: '@Url.Content("~/History/GetFormulaList")',
                            data: { mid: templeteID },
                            type: "POST",
                            success: function (data) {
                                var dataParse = eval(data.tree);
                                console.log("从 mid 获取的之前模板中的所有公式:", dataParse);
                                if (dataParse) {
                                    for (var i = 0, len = dataParse.length; i < len; i++) {
                                        dataFormula.push(dataParse[i]);
                                    }
                                    // 使用 updateFormulaList 方法更新公式列表页
                                    updateFormulaList(dataFormula);
                                }
                            },
                            error: function (error) {
                                console.error(error);
                            }
                        });

                    }
                }
        });




    </script>
</head>
<body>
    <div id="dialogBg"></div>
    <div id="dialogBg_confirm"></div>

    <div id="tem_dialog">
        <div class="tem_dialog_top">
            <span class="tem_dialog_name">保存模板</span>
            <div class="btn_close" id="tem_btn_close"></div>
        </div>
        <div class="tem_dialog_body">
            <div id="tem_save_title">模板名称</div>
            <div id="tem_save_content">
                <input type="text" name="" id="tem_save_input" class="confirm_formula_title" spellcheck="false" />
            </div>
        </div>
        <div class="tem_dialog_bottom">
            <button class="dis_operate_btn" id="tem_btn_cancel">取消</button>
            <button class="dis_operate_btn" id="tem_btn_save">保存</button>
        </div>
    </div>
    @*<div id="dv_Load_body" class="dialog">*@
    <div class="dialog_load" id="dialog_load"></div>
    @*</div>*@

    <div id="dv_formula">
        @*
            <div class="dialog_top">
                <span class="dialog_name">公式</span>
                <div class="btn_close" onclick="CloseDiv('dv_Formula', '')"></div>
            </div>
            @*公式列表*@
        @*<div id="dv_Operate" style="width:1000px; height:44px; text-align:center;">*@
        @*<div id="btn_Del" class="button_save" style=" align-content:center;">Del</div>*@
        @*<div id="btn_Edit"  class="button_save" style=" align-content:center;" >Edit</div>*@
        @*<div id="btn_Add" class="button_save" style="align-content:center; margin-right:10px;">添加</div>
            </div>
            <div id="dv_Formula_right" style="width: 1000px; height: 500px; border-top:1px solid #dcdcdc;">
                <div id="dv_list"></div>
            </div>*@
        @*公式列表*@
        @*添加公式  编辑公式*@


        <div id="dv_formula_show" class="formula_dialog">
            <!-- 公示列表展示 -->
            <div class="dialog_top">
                <div class="dialog_name">公式列表</div>
                <div class="btn_close" id="dv_formula_show_close"></div>
            </div>
            <div class="dialog_body">
                <div id="formula_list_container">
                    <table id="formula_list_title" class="formula_list">
                        <tr>
                            <th class="formula_list_title_name">公式名称</th>
                            <th class="formula_list_title_formula">公式内容</th>
                            <th class="formula_list_title_operate">操作</th>
                            <th class="formula_list_title_check">是否呈现</th>
                        </tr>
                    </table>
                    <div id="formula_list_content_container">
                        <table id="formula_list_content" class="formula_list">
                            
                        </table>
                    </div>
                </div>
            </div>
            <div class="dialog_bottom" id="dv_operate">
                <button class="dis_operate_btn" id="dv_operate_btn_cancel">关闭</button>
                <button class="dis_operate_btn" id="dv_operate_btn_add">新建</button>
            </div>
        </div>

        <div id="dv_formula_modify" class="formula_dialog">
            <!-- 公式列表新建与编辑 -->
            <div class="dialog_top">
                <span class="dialog_name">参数集合</span>
                <div class="btn_close" id="dv_formula_modify_close"></div>
            </div>
            <div class="dialog_body">
                <div class="dialog_body_line">
                    <div class="dialog_body_part">
                        <div id="dis_title">函数及操作符信息</div>
                        <div id="dis_formula">
                            <table id="math_formula">
                                <tr>
                                    <td>abs(x)</td>
                                </tr>
                                <tr>
                                    <td>cos(x)</td>
                                </tr>
                                <tr>
                                    <td>exp(x)</td>
                                </tr>
                                <tr>
                                    <td>floor(x)</td>
                                </tr>
                                <tr>
                                    <td>log(x)</td>
                                </tr>
                                <tr>
                                    <td>max(value1, value2, ...)</td>
                                </tr>
                                <tr>
                                    <td>min(value1, value2, ...)</td>
                                </tr>
                                <tr>
                                    <td>sin(x)</td>
                                </tr>
                                <tr>
                                    <td>tan(x)</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="dialog_body_part">
                        <div id="dis_formula_intro">数学公式介绍</div>
                    </div>
                    <div id="dis_input" class="dialog_body_part">
                        <div class="dis_input_line">
                            <button class="dis_input_btn" id="dis_input_btn_7">7</button>
                            <button class="dis_input_btn" id="dis_input_btn_8">8</button>
                            <button class="dis_input_btn" id="dis_input_btn_9">9</button>
                            <button class="dis_input_btn dis_input_btn_punc" id="dis_input_btn_/">÷</button>
                        </div>
                        <div class="dis_input_line">
                            <button class="dis_input_btn" id="dis_input_btn_4">4</button>
                            <button class="dis_input_btn" id="dis_input_btn_5">5</button>
                            <button class="dis_input_btn" id="dis_input_btn_6">6</button>
                            <button class="dis_input_btn dis_input_btn_punc" id="dis_input_btn_*">×</button>
                        </div>
                        <div class="dis_input_line">
                            <button class="dis_input_btn" id="dis_input_btn_1">1</button>
                            <button class="dis_input_btn" id="dis_input_btn_2">2</button>
                            <button class="dis_input_btn" id="dis_input_btn_3">3</button>
                            <button class="dis_input_btn dis_input_btn_punc" id="dis_input_btn_+">+</button>
                        </div>
                        <div class="dis_input_line">
                            <button class="dis_input_btn" id="dis_input_btn_0">0</button>
                            <button class="dis_input_btn" id="dis_input_btn_.">.</button>
                            <button class="dis_input_btn dis_input_btn_sm dis_input_btn_punc" id="dis_input_btn_(">(</button>
                            <button class="dis_input_btn dis_input_btn_sm dis_input_btn_punc" id="dis_input_btn_)">)</button>
                            <button class="dis_input_btn dis_input_btn_punc" id="dis_input_btn_-">-</button>
                        </div>
                    </div>
                </div>
                <div class="dialog_body_line">
                    <div id="station_list_container" class="dialog_body_part">
                        <table class="station_list station_list_title">
                            <tr>
                                <th class="station_list_title_data">数据源</th>
                                <th class="station_list_title_name">名称</th>
                                <th class="station_list_title_value">值</th>
                            </tr>
                        </table>
                        <div class="station_list_content_container">
                            <table class="station_list" id="station_list_content">
                                @*<tr>
                                        <td class="station_list_content_data">0320000143</td>
                                        <td class="station_list_content_name">逆变器N13交流电压</td>
                                        <td class="station_list_content_value">404.4</td>
                                    </tr>
                                    <tr>
                                        <td class="station_list_content_data">0320000144</td>
                                        <td class="station_list_content_name">逆变器N13交流电流</td>
                                        <td class="station_list_content_value">8.7</td>
                                    </tr>
                                    <tr>
                                        <td class="station_list_content_data">0320000145</td>
                                        <td class="station_list_content_name">逆变器N14交流电压</td>
                                        <td class="station_list_content_value">398.1</td>
                                    </tr>
                                    <tr>
                                        <td class="station_list_content_data">0320000146</td>
                                        <td class="station_list_content_name">逆变器N14交流电流</td>
                                        <td class="station_list_content_value">9.0</td>
                                    </tr>
                                    <tr>
                                        <td class="station_list_content_data">0320000147</td>
                                        <td class="station_list_content_name">逆变器N15交流电压</td>
                                        <td class="station_list_content_value">400.2</td>
                                    </tr>
                                    <tr>
                                        <td class="station_list_content_data">0320000148</td>
                                        <td class="station_list_content_name">逆变器N15交流电流</td>
                                        <td class="station_list_content_value">9.2</td>
                                    </tr>*@
                            </table>
                        </div>
                    </div>
                    <div id="dis_output" class="dialog_body_part">
                        <div id="dis_output_formula" contenteditable="true" spellcheck="false" data-value=""></div>
                        <div id="dis_output_result">输出预览：<span id="dis_output_result_cal">NaN</span></div>
                    </div>
                </div>
            </div>
            <div class="dialog_bottom">
                <button class="dis_operate_btn" id="dis_operate_btn_cancel">取消</button>
                <button class="dis_operate_btn" id="dis_operate_btn_save">保存</button>
                <!-- <button class = "dis_operate_btn" id = "dis_operate_btn_test">测试</button> -->
            </div>
        </div>

        <input id="dis_name" style="display:none;" />@*隐藏域  用于存储查询过的所有的公式名称*@
        <input id="dis_con" style="display:none;" />@*隐藏域  用于存储查询过的所有的公式*@
        <input id="dis_id" style="display:none;" />@*隐藏域  用于存储模板编码*@
        <input id="dis_title" style="display:none;" />@*隐藏域    存储要编辑的公式标题*@
        <input id="dis_formula" style="display:none;" />@*隐藏域  存储要编辑的公式内容*@

        <input id="fla_title" style="display:none;" />@*隐藏域  所有公式名称 字符串*@
        <input id="fla_connect" style="display:none;" />@*隐藏域  所有公式内容 字符串*@
        @*添加公式*@
    </div>

    <div id="dv_formula_confirm" class="dv_formula_confirm">
        <div class="dialog_confirm_top">
            确认保存
        </div>
        <div class="dialog_confirm_body">
            <div class="dialog_confirm_body_name">
                <div class="dialog_confirm_body_name_title">
                    请输入公式名称：
                </div>
                <div class="dialog_confirm_body_name_input">
                    <input type="text" name="" id="confirm_formula_title" class = "confirm_formula_title" spellcheck="false" />
                </div>
            </div>
            <div class="dialog_confirm_body_formula" id="dialog_confirm_body_formula">

            </div>
        </div>
        <div class="dialog_confirm_bottom">
            <button class="dis_operate_btn" id="confirm_btn_cancel">取消</button>
            <button class="dis_operate_btn" id="confirm_btn_save">保存</button>
        </div>
    </div>


    <div class="right_menu">
        <div id="btn_table"></div>
        <div id="btn_line"></div>
        <div id="btn_back"></div>
    </div>
    <div id="dv_body" class="container_2">

        <div id="dv_left" class="dv_left" style="margin-top:12px;">
            @*<div class="dv_toolbar">
                    <div class="frame_search">
                        <input id="txtSearch" value="" type="search" class="input_search">
                        <div id="btnSearch" class="button_search"></div>
                    </div>
                </div>*@
            <div class="zTreeDemoBackground" style="height:532px;">
                <ul id="tree" class="ztree"></ul>
            </div>
        </div>
        <div id="dv_right" class="dv_right">
            <div id="dv_Conditions" class="dv_toolbar">
                <span id="start" class="toolbar_text">开始</span>
                <div class="dv_time">
                    <input id="sDate" class="Wdate_gray" readonly="readonly"
                           type="text" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd 00:00:00' ,lang: 'zh-cn'})" />
                    @*<input id="sDate" value="" />
                        <div id="cl"></div>*@
                </div>
                <span id="end" class="toolbar_text">结束</span>
                <div class="dv_time">
                    <input id="eDate" class="Wdate_gray" readonly="readonly"
                           type="text" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd HH:mm:00', lang: 'zh-cn' })" />
                    @*<input id="eDate" value="" />
                        <div id="cle"></div>*@
                </div>
                <span id="jiange" class="toolbar_text">间隔时间</span>
                <div class="dv_span"><input id="txt_jiange" class="input_span" value="60"></div>
                <select id="sec_jiange" class="dv_spanlist">
                    <option value="3">秒</option>
                    <option value="2">分</option>
                    <option value="1">时</option>
                </select>

                <div id="btn_chart" href="#" class="button_save" data-options="iconCls:'icon-save'" style="width:80px;margin-left:2px;" onclick="updatepoint()">更新测点</div>
                <div id="btn_save" href="#" class="button_save" data-options="iconCls:'icon-save'" style="margin-left:2px;">保存</div>
                <div id="btn_print" href="#" class="button_save" data-options="iconCls:'icon-save'" style="margin-left:2px;">打印</div>
                <div id="btn_Formula" href="#" class="button_save" data-options="iconCls:'icon-save'" style="margin-left:2px;">公式</div>
                <div id="btn_chart_show" href="#" class="button_save" data-options="iconCls:'icon-save'" style="margin-left:2px;">查询</div>
            </div>
            <div class="right_bottom">
                <div id="container" style="width: 822px; height: 488px; margin:0px;"></div>
                <div id="dv_table" style="width: 822px; height: 488px; margin: 0px; overflow-y: auto; display: none;"></div>
            </div>
        </div>
    </div>
</body>
</html>
